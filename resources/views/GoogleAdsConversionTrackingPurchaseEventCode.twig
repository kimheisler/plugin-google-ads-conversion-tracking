<script type="text/plain" data-cookie-consent="{{ config('GoogleAdsConversionTracking.consentGroup') }}.GoogleAdsConversionTracking">
    {% set shippingCosts = 0 %}
    {% set webstoreConfig = services.webstoreConfig.getWebstoreConfig() %}
    {% set useGross = config("GoogleAdsConversionTracking.submitGrossPrices") == "true" %}

    {% if trackOrder %}
        {% set data = services.customer.getLatestOrder() %}
        {% if data is defined %}
            {# Calculate shipping costs #}
            {% for item in data.order.orderItems %}

                {% if item.typeId == 6 %}
                    {% if useGross %}
                    {% set shippingCosts = shippingCosts + item.amounts[0].priceGross %}
                    {% else %}
                    {% set shippingCosts = shippingCosts + item.amounts[0].priceNet %}
                    {% endif %}
                {% endif %}
            {% endfor %}
                gtag('consent', 'default', {
                  'ad_storage': 'granted',
                  'ad_user_data': 'granted',
                  'ad_personalization': 'granted',
                  'analytics_storage': 'granted'
                });
                gtag("event", "conversion", {
                    send_to: "{{ config("GoogleAdsConversionTracking.trackingId") }}/{{ config("GoogleAdsConversionTracking.trackingLabel") }}",
                    transaction_id: "{{ data.order.id }}",
                    value: "{% if useGross %}{{ data.order.amounts[0].grossTotal }}{% else %}{{ data.order.amounts[0].netTotal }}{% endif %}",
                    currency: "{{ data.order.amounts[0].currency }}"
                });
        {% endif %}
    {% endif %}
</script>
